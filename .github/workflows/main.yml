#   Licensed to the Apache Software Foundation (ASF) under one or more
#   contributor license agreements.  See the NOTICE file distributed with
#   this work for additional information regarding copyright ownership.
#   The ASF licenses this file to You under the Apache License, Version 2.0
#   (the "License"); you may not use this file except in compliance with
#   the License.  You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
---
name: Build

on:
  - push
  - pull_request

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"
    steps:
      - name: Check out source code
        uses: actions/checkout@v2
      - name: Build images
        run: |
          docker build -t jena jena
          docker build -t jena-fuseki jena-fuseki
      - name: Test images
        run: |
          set -euo pipefail

          # Does the Jena image run at all?
          docker run --rm jena riot --version

          # Simple RIOT round-trip
          echo "<http://example.com/a> <http://example.com/b> <http://example.com/c> ." > /tmp/example.ttl
          docker run --rm -v /tmp:/rdf jena riot /rdf/example.ttl > /tmp/example.nq
          grep -q example.com /tmp/example.nq

          # Start Fuseki
          docker run --name fuseki -p 127.0.0.1:3030:3030 -d jena-fuseki

          # Wait until HTTP is ready (more reliable than scraping logs)
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:3030/ >/dev/null; then
              break
            fi
            sleep 2
          done

          # Show logs for context
          docker logs fuseki

          # Check admin password is printed and UI is up
          docker logs fuseki 2>&1 | grep -q '^admin='
          curl -fsS http://127.0.0.1:3030/ | grep -q 'Fuseki'

          # Graceful shutdown and cleanup
          docker kill --signal=SIGINT fuseki
          docker wait fuseki >/dev/null
          docker rm fuseki

          # Ensure nothing left running
          test -z "$(docker ps -q)"